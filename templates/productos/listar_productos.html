{% extends 'base.html' %}
{% load static %}
{% block page_styles %}
<link rel="stylesheet" href="{% static 'css/productos/listar_productos.css' %}">
<link rel="stylesheet" href="{% static 'css/productos/ver.css' %}">
{% endblock %}
{% block content %}
<section>
  <h2>Productos disponibles</h2>
  
  <!-- Filtros y búsqueda -->
  <div class="filters-container">
    <div class="search-box">
      <input 
        type="text" 
        id="search-input" 
        placeholder="Buscar por nombre..." 
        class="search-input"
      >
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
    </div>
    
    <div class="price-filter">
      <label for="price-range">Precio máximo:</label>
      <input 
        type="range" 
        id="price-range" 
        min="0" 
        max="10000" 
        value="10000" 
        class="price-slider"
      >
      <span id="price-value">$10000</span>
    </div>
  </div>

  <!-- Mensaje de sin resultados -->
  <div id="no-results" class="no-results" style="display: none;">
    <p>No se encontraron productos que coincidan con tu búsqueda.</p>
  </div>

  <!-- Grid de productos -->
  <div class="products-grid" id="products-grid">
    {% for p in products %}
    <div class="product-card" data-name="{{ p.name|lower }}" data-price="{{ p.price }}">
      {% if p.photo %}
        <img src="{{ p.photo.url }}" alt="{{ p.name }}" class="card__img">
      {% else %}
        <div class="card__img-placeholder">Sin foto</div>
      {% endif %}
      <h3>{{ p.name }}</h3>
      <p class="product-description">{{ p.description|truncatewords:20 }}</p>
      <div class="product-info">
        <div class="product-price">${{ p.price }}</div>
        <div class="product-status">{{ p.get_status_display }}</div>
      </div>
      <div class="product-actions">
        <button class="btn" data-open="product-view-modal"
              data-name="{{ p.name }}" 
              data-description="{{ p.description }}" 
              data-price="{{ p.price }}"
              data-status="{{ p.get_status_display }}" 
              data-photo-url="{% if p.photo %}{{ p.photo.url }}{% endif %}">
          Ver detalles
        </button>
        {% if request.user.is_authenticated and request.user.profile.role == 'buyer' %}
        <button class="btn-cart" title="Añadir al carrito" data-product-id="{{ p.id }}">
          <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-0.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l0.02-.12 0.9-1.63h7.45c0.75 0 1.41-.41 1.75-1.03l3.58-6.49c0.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-0.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s0.89 2 1.99 2 2-0.9 2-2-0.9-2-2-2z"/></svg>
        </button>
        {% endif %}
      </div>
    </div>
    {% empty %}
    <p class="empty-message">No hay productos disponibles.</p>
    {% endfor %}
  </div>
</section>
{% include 'productos/ver.html' %}
{% endblock %}
{% block page_scripts %}
<script src="{% static 'js/productos/ver.js' %}"></script>
<script src="{% static 'js/productos/buscar.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('.btn-cart').forEach(function(btn){
    btn.addEventListener('click', function(){
      const id = this.getAttribute('data-product-id');
      if(!id) return;
      var csrftoken = (function(){
        var name='csrftoken';var cookies=document.cookie.split(';');
        for(var i=0;i<cookies.length;i++){var c=cookies[i].trim();if(c.substring(0,name.length+1)===(name+'=')){return decodeURIComponent(c.substring(name.length+1));}}
        return '';
      })();
      fetch('/cart/add/' + id + '/', {method: 'POST', headers: {'X-CSRFToken': csrftoken}})
        .then(r=>r.json())
        .then(data=>{
          if(data.ok){
            const el = document.getElementById('cart-count');
            if(el){ el.textContent = data.count; }
          } else {
            alert(data.message || 'No se pudo agregar');
          }
        })
        .catch(()=>{});
    });
  });
});
</script>
{% endblock %}
